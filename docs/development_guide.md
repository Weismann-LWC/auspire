# Auspire 开发文档

## 📋 项目架构概览

### 核心设计理念

Auspire 采用模块化服务架构，每个命理概念都被封装为独立的服务模块。这种设计具有以下优势：

1. **高内聚低耦合**: 每个服务专注单一职责，便于理解和维护
2. **易于扩展**: 添加新功能只需创建新的服务模块
3. **便于测试**: 每个模块可以独立进行单元测试
4. **代码复用**: 服务可以在不同场景下重复使用

### MVC 架构模式

虽然项目主要使用Go语言开发，但仍遵循类似MVC的设计模式：

- **Models** (`models/`): 数据结构定义和数据传输对象
- **Views** (`static/`): 静态HTML/CSS/JS文件，前端界面
- **Controllers** (`handlers/`): 请求处理器，协调服务调用
- **Services** (`services/`): 核心业务逻辑实现

## 🏗️ 核心服务模块详解

### 1. 八字基础服务 (`bazi_service.go`)

这是整个系统的核心服务，负责八字四柱的基础计算。

#### 主要功能

- **年柱计算**: 基于公元年的天干地支计算
- **月柱计算**: 基于节气的精确月柱计算
- **日柱计算**: 基于1900年基准的日柱计算  
- **时柱计算**: 基于日柱和时辰的地支时柱计算
- **增强计算**: 整合所有专业服务的结果

#### 关键算法

##### 年柱计算公式

```go
yearGanIndex := (year - 4) % 10  // 天干索引
yearZhiIndex := (year - 4) % 12  // 地支索引
```

##### 月柱计算 (基于节气)

月柱是八字中最复杂的部分，必须严格按照节气计算：

- 立春(2/4) 开始为寅月
- 惊蛰(3/6) 开始为卯月  
- 清明(4/5) 开始为辰月
- 立夏(5/6) 开始为巳月
- 芒种(6/6) 开始为午月
- 小暑(7/7) 开始为未月
- 立秋(8/8) 开始为申月
- 白露(9/8) 开始为酉月
- 寒露(10/8) 开始为戌月
- 立冬(11/8) 开始为亥月
- 大雪(12/7) 开始为子月
- 小寒(1/6) 开始为丑月

##### 天干地支五行对照

```go
// 天干五行对照表
tianGanWuXing = map[string]string{
    "甲": "木", "乙": "木", "丙": "火", "丁": "火", "戊": "土",
    "己": "土", "庚": "金", "辛": "金", "壬": "水", "癸": "水",
}

// 地支五行对照表  
diZhiWuXing = map[string]string{
    "子": "水", "丑": "土", "寅": "木", "卯": "木", "辰": "土", "巳": "火",
    "午": "火", "未": "土", "申": "金", "酉": "金", "戌": "土", "亥": "水",
}
```

### 2. 十二长生服务 (`shi_er_zhang_sheng.go`)

这是传统命理学中的核心概念之一，描述了五行能量在十二地支中的生命周期循环。

#### 理论基础

十二长生代表能量的自然循环过程：

1. **长生** (Chang Sheng) - 出生/开始生长
2. **沐浴** (Mu Yu) - 洗涤/准备期  
3. **冠带** (Guan Dai) - 成熟初期
4. **临官** (Lin Guan) - 接近鼎盛
5. **帝旺** (Di Wang) - 峰值状态
6. **衰** (Shuai) - 开始衰退
7. **病** (Bing) - 进一步虚弱
8. **死** (Si) - 结束当前周期
9. **墓** (Mu) - 储存/休眠期
10. **绝** (Jue) - 断绝/完全分离
11. **胎** (Tai) - 怀孕/新开始形成
12. **养** (Yang) - 养育/准备重生

#### 关键原则

1. **阳干顺排，阴干逆排**
   - 阳干(甲、丙、戊、庚、壬)按地支顺序正向排列
   - 阴干(乙、丁、己、辛、癸)按地支顺序反向排列

2. **每个天干有独特循环**
   - 甲木: 亥(长生) → 子(沐浴) → 丑(冠带) ...
   - 乙木: 午(长生) → 巳(沐浴) → 辰(冠带) ...

#### 实现细节

```go
// 阳干顺排示例 - 甲木的十二长生序列
"甲": {"亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌"}

// 阴干逆排示例 - 乙木的十二长生序列  
"乙": {"午", "巳", "辰", "卯", "寅", "丑", "子", "亥", "戌", "酉", "申", "未"}
```

### 3. 主星服务 (`zhuxing_service.go`)

负责计算天干间的十神关系，这是八字分析的基础。

#### 十神关系体系

十神代表了日主(自己)与其他天干的关系：

| 我与他人关系 | 同性 | 异性 |
|-------------|------|------|
| 生我者(得帮助) | 偏印 | 正印 |
| 克我者(受约束) | 七杀 | 正官 |
| 我克者(我控制) | 偏财 | 正财 |
| 我生者(我付出) | 食神 | 伤官 |
| 同我者(同类人) | 比肩 | 劫财 |

#### 计算逻辑

1. **确定五行关系**:
   - 相生: 木生火、火生土、土生金、金生水、水生木
   - 相克: 木克土、土克水、水克火、火克金、金克木

2. **判断阴阳属性**:
   - 阳干: 甲、丙、戊、庚、壬
   - 阴干: 乙、丁、己、辛、癸

3. **应用十神规则**:
   ```go
   if dayGan == targetGan {
       return "比肩"  // 同天干为比肩
   }
   
   switch {
   case dayWuXing == targetWuXing:  // 同五行
       if sameYinYang { return "比肩" } else { return "劫财" }
   case isShengRelation(dayWuXing, targetWuXing):  // 日主生目标
       if sameYinYang { return "食神" } else { return "伤官" }
   // ... 其他情况
   }
   ```

### 4. 藏干服务 (`canggan_service.go`)

分析地支中隐藏的天干成分。

#### 地支藏干规律

每个地支都包含1-3个隐藏天干：

- **单一藏干**: 子(癸)、卯(乙)、酉(辛)、亥(壬)
- **双重藏干**: 寅(甲丙戊)、巳(丙庚戊)、午(丁己)、申(庚壬戊)
- **三重藏干**: 丑(己癸辛)、辰(戊乙癸)、未(己丁乙)、戌(戊辛丁)

#### 气质分析

藏干不仅包含天干，还有不同的气质比例：

- **本气** (Major Qi): 主要成分，力量最强
- **中气** (Medium Qi): 次要成分，中等力量  
- **余气** (Residual Qi): 残留成分，力量最弱

### 5. 副星服务 (`fuxing_service.go`)

基于藏干的十神分析，提供更深层次的命理洞察。

#### 分析维度

1. **藏干十神**: 每个藏干相对于日主的十神关系
2. **力量权重**: 不同气质藏干的力量影响
3. **组合效应**: 多个藏干形成的复合影响

### 6. 纳音服务 (`nayin_service.go`)

六十甲子的纳音五行，反映更深层次的能量特质。

#### 纳音分类

- **金**: 海中金、金箔金、白蜡金、沙中金
- **木**: 大林木、松柏木、杨柳木、石榴木  
- **水**: 涧下水、大溪水、长流水、大海水
- **火**: 炉中火、山头火、霹雳火、山下火
- **土**: 城头土、屋上土、壁上土、大驿土

### 7. 星运服务 (`xingyun_service.go`)

分析地支在日主五行下的运程状态，与十二长生相关但应用场景不同。

### 8. 自坐服务 (`zizuo_service.go`)

分析天干在所坐地支中的状态，体现个人根基。

### 9. 空亡服务 (`kongwang_service.go`)

基于日柱的旬空计算，反映能量缺失的领域。

### 10. 神煞服务 (`shensha_service.go`)

各种神煞星的计算，增加命理分析的丰富性。

## 🛠️ 代码质量保证

### 命名规范

- **文件命名**: 使用下划线分隔，如 `bazi_service.go`
- **类型命名**: 使用驼峰命名，如 `BaziService`
- **函数命名**: 使用驼峰命名，如 `CalculateBazi`
- **变量命名**: 使用驼峰命名，如 `dayColumn`

### 注释标准

每个导出的类型、函数都需要详细注释：

```go
// CalculateBazi 计算八字四柱
//
// 参数:
//   - req: 包含姓名、出生日期、时间的请求对象
//
// 返回:
//   - BaziResponse: 包含八字计算结果的响应对象
//   - error: 计算过程中可能出现的错误
func (s *BaziService) CalculateBazi(req models.BaziRequest) (*models.BaziResponse, error) {
    // 实现...
}
```

### 错误处理

统一的错误处理机制：

```go
if err != nil {
    return &models.BaziResponse{
        Name:  req.Name,
        Error: err.Error(),
    }, err
}
```

## 🧪 测试策略

### 单元测试

每个服务模块都应该有对应的测试文件：

```
services/
├── bazi_service.go
├── bazi_service_test.go
└── ...
```

### 集成测试

通过API接口进行端到端测试：

```bash
curl -X POST http://localhost:8080/api/bazi \
  -H "Content-Type: application/json" \
  -d '{"name":"测试","birthDate":"1990-01-01","birthTime":"12:00"}'
```

## 🔧 部署与运维

### 环境变量配置

```bash
export REDIS_ADDR=localhost:6379
export REDIS_PASSWORD=""
export JWT_SECRET=your-secret-key
export JWT_ISSUER=auspire
```

### Docker 部署 (可选)

```dockerfile
FROM golang:1.19-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o auspire .

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/auspire .
COPY --from=builder /app/static ./static
EXPOSE 8080
CMD ["./auspire"]
```

## 🚀 性能优化

### 缓存策略

对于不变的基础数据(如五行对照表)使用包级别变量：

```go
var tianGanWuXing = map[string]string{
    "甲": "木", "乙": "木", // ...
}
```

### 计算优化

避免重复计算，尽量复用已有结果：

```go
// 计算一次，多次使用
dayColumn := bazi[2]
dayGan := dayColumn.Gan
```

## 🔄 版本升级指南

### API 兼容性

保持向后兼容性，新增字段使用 `omitempty` 标签：

```go
type BaziColumn struct {
    NewField string `json:"newField,omitempty"`  // 新增字段
}
```

### 数据迁移

对于破坏性变更，提供数据迁移脚本。

## 📚 参考文献

1. 《子平真诠》- 沈孝瞻著
2. 《穷通宝鉴》- 余春台著  
3. 《三命通会》- 万民英著
4. 《滴天髓》- 刘基著
5. 《渊海子平》- 徐大升著

---

*本文档持续更新中，如有疑问请查阅源码或联系项目维护者。*